<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Booking App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@latest"></script>
    <style>
        /* Custom CSS for the message box */
        #message-box {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f0fdf4;
            color: #15803d;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #16a34a;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        #message-box.show {
            display: block;
        }
        #message-box.error {
            background-color: #fee2e2;
            color: #dc2626;
            border-color: #ef4444;
        }
        .seat-available {
            background-color: #f0fdf4; /* Tailwind green-100 */
            color: #15803d; /* Tailwind green-700 */
            border: 1px solid #16a34a;
        }
        .seat-available:hover {
             background-color: #d1fae5; /* Tailwind green-200 */
        }

        .seat-booked {
            background-color: #fee2e2; /* Tailwind red-100 */
            color: #dc2626; /* Tailwind red-700 */
            border: 1px solid #ef4444;
        }

        .seat-selected {
            background-color: #fde68a;  /* Tailwind amber-100 */
            color: #d97706;  /* Tailwind amber-700 */
            border: 1px solid #fcd34d;  /* Tailwind amber-300 */
        }

    </style>
</head>
<body class="bg-gray-100 font-inter">
    <div class="container mx-auto p-6">
        <div id="message-box" class=""></div> <h1 class="text-3xl font-semibold text-blue-600 text-center mb-8">Ticket Booking App</h1>

        <nav class="bg-white rounded-md shadow-md mb-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-xl font-semibold text-gray-800">BookMyTicket</span>
                    </div>
                    <div class="flex items-center">
                        <div class="hidden md:block">
                            <div class="ml-10 flex items-baseline space-x-4">
                                <a href="#" id="home-link" class="text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Home</a>
                                <a href="#" id="login-link" class="text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Login</a>
                                <a href="#" id="register-link" class="text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Register</a>
                                <a href="#" id="logout-link" class="hidden text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Logout</a>
                                <a href="#" id="profile-link" class="hidden text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Profile</a>
                                <a href="#" id="journeys-link" class="hidden text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">Journeys</a>
                                 <a href="#" id="my-bookings-link" class="hidden text-gray-500 hover:bg-gray-100 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">My Bookings</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main id="main-content">
            </main>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000'; // Django backend URL
        const messageBox = document.getElementById('message-box');

        // Helper function to display messages
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = `fixed top-4 left-1/2 transform -translate-x-1/2 bg-${type === 'success' ? 'green' : 'red'}-100 text-${type === 'success' ? 'green' : 'red'}-700 border border-${type === 'success' ? 'green' : 'red'}-400 px-4 py-2 rounded shadow-md z-50`;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Auto-hide after 3 seconds
        }

        // Helper function to make API requests
        async function fetchData(url, method = 'GET', body = null, headers = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
            };
            const requestHeaders = { ...defaultHeaders, ...headers };

            const options = {
                method,
                headers: requestHeaders,
                body: body ? JSON.stringify(body) : null,
            };

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Something went wrong'); //Improved error message
                }
                return await response.json();
            } catch (error) {
                showMessage(error.message || 'Failed to fetch data', 'error');
                throw error; // Re-throw to be caught by caller
            }
        }

        // --- Authentication Views ---
        const registerView = `
            <div class="max-w-md mx-auto bg-white rounded-md shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Register</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                        <input type="text" id="username" name="username" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="email" name="email" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                        <input type="password" id="password" name="password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="first_name" class="block text-gray-700 text-sm font-bold mb-2">First Name:</label>
                        <input type="text" id="first_name" name="first_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="last_name" class="block text-gray-700 text-sm font-bold mb-2">Last Name:</label>
                        <input type="text" id="last_name" name="last_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Register</button>
                </form>
                <div class="mt-4 text-sm text-gray-600">
                    Already have an account? <a href="#" id="login-link" class="text-blue-500 hover:text-blue-700 font-semibold">Login</a>
                </div>
            </div>
        `;

        const loginView = `
            <div class="max-w-md mx-auto bg-white rounded-md shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-gray-700 text-sm font-bold mb-2">Username:</label>
                        <input type="text" id="username" name="username" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password:</label>
                        <input type="password" id="password" name="password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Login</button>
                </form>
                <div class="mt-4 text-sm text-gray-600">
                    Don't have an account? <a href="#" id="register-link" class="text-blue-500 hover:text-blue-700 font-semibold">Register</a>
                </div>
            </div>
        `;

        const profileView = `
            <div class="max-w-md mx-auto bg-white rounded-md shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Profile</h2>
                <div id="profile-details" class="space-y-2 mb-4">
                    <p><span class="font-semibold">Username:</span> <span id="profile-username"></span></p>
                    <p><span class="font-semibold">Email:</span> <span id="profile-email"></span></p>
                    <p><span class="font-semibold">First Name:</span> <span id="profile-first-name"></span></p>
                    <p><span class="font-semibold">Last Name:</span> <span id="profile-last-name"></span></p>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Change Password</h3>
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label for="old_password" class="block text-gray-700 text-sm font-bold mb-2">Old Password:</label>
                        <input type="password" id="old_password" name="old_password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="new_password" class="block text-gray-700 text-sm font-bold mb-2">New Password:</label>
                        <input type="password" id="new_password" name="new_password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Change Password</button>
                </form>
                <h3 class="text-lg font-semibold text-gray-800 mt-6 mb-4">Update Profile</h3>
                <form id="update-profile-form" class="space-y-4">
                    <div>
                        <label for="edit_email" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="edit_email" name="email" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="edit_first_name" class="block text-gray-700 text-sm font-bold mb-2">First Name:</label>
                        <input type="text" id="edit_first_name" name="first_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="edit_last_name" class="block text-gray-700 text-sm font-bold mb-2">Last Name:</label>
                        <input type="text" id="edit_last_name" name="last_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Update Profile</button>
                </form>
            </div>
        `;

        async function handleRegister(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                await fetchData(`${API_BASE_URL}/auth/register/`, 'POST', data);
                showMessage('Registration successful! Please login.');
                showView('login'); // Redirect to login
            } catch (error) {
                // Error is already handled in fetchData
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetchData(`${API_BASE_URL}/auth/login/`, 'POST', data);
                const responseData = await response.json();
                localStorage.setItem('authToken', responseData.token); // Store the token
                showMessage('Login successful!');
                // Update UI for logged-in user
                document.getElementById('login-link').classList.add('hidden');
                document.getElementById('register-link').classList.add('hidden');
                document.getElementById('logout-link').classList.remove('hidden');
                document.getElementById('profile-link').classList.remove('hidden');
                document.getElementById('journeys-link').classList.remove('hidden');
                document.getElementById('my-bookings-link').classList.remove('hidden');
                loadProfile();  // Load profile data after successful login
                showView('home');
            } catch (error) {
               // Error is already handled in fetchData
            }
        }

        function handleLogout() {
            localStorage.removeItem('authToken'); // Remove the token
            fetchData(`${API_BASE_URL}/auth/logout/`, 'POST')
                .then(() => {
                    showMessage('Logout successful!');
                    // Update UI for logged-out user
                    document.getElementById('login-link').classList.remove('hidden');
                    document.getElementById('register-link').classList.remove('hidden');
                    document.getElementById('logout-link').classList.add('hidden');
                    document.getElementById('profile-link').classList.add('hidden');
                     document.getElementById('journeys-link').classList.add('hidden');
                    document.getElementById('my-bookings-link').classList.add('hidden');
                    showView('home');
                })
                .catch(error => {
                    showMessage('Logout failed', 'error');
                });
        }

        async function loadProfile() {
            try {
                const data = await fetchData(`${API_BASE_URL}/auth/profile/`, 'GET', null, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });

                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-email').textContent = data.email;
                document.getElementById('profile-first-name').textContent = data.first_name;
                document.getElementById('profile-last-name').textContent = data.last_name;
                document.getElementById('edit_email').value = data.email;
                document.getElementById('edit_first_name').value = data.first_name;
                document.getElementById('edit_last_name').value = data.last_name;

            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                await fetchData(`${API_BASE_URL}/auth/change-password/`, 'POST', data, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                showMessage('Password changed successfully!');
                form.reset();
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const updatedData = await fetchData(`${API_BASE_URL}/auth/profile/`, 'PUT', data, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                showMessage('Profile updated successfully!');
                loadProfile(); // Refresh profile data in the view
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        // --- Journey Views ---
        const journeysView = `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800">Available Journeys</h2>
                <div class="bg-white rounded-md shadow-md p-4 space-y-4">
                    <div class="flex space-x-4">
                        <input type="text" id="filter-source" placeholder="Source" class="shadow appearance-none border rounded w-auto py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <input type="text" id="filter-destination" placeholder="Destination" class="shadow appearance-none border rounded w-auto py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <input type="date" id="filter-departure-date" placeholder="Departure Date" class="shadow appearance-none border rounded w-auto py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <button id="search-journeys" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Search</button>
                    </div>
                </div>
                <div id="journeys-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
            </div>
        `;

        const journeyCardTemplate = (journey) => `
            <div class="bg-white rounded-md shadow-md p-4 flex flex-col justify-between">
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">${journey.source} to ${journey.destination}</h3>
                    <p class="text-gray-600 mb-1">Departure: ${journey.departure_time}</p>
                    <p class="text-gray-600 mb-1">Arrival: ${journey.arrival_time}</p>
                    <p class="text-gray-600 mb-1">Transport: ${journey.transport_type} - ${journey.transport_name} ${journey.transport_number}</p>
                    <p class="text-gray-600 mb-2">Available Seats: ${journey.available_seats} / ${journey.total_seats}</p>
                    <p class="text-gray-700 font-bold mb-2">Price: ₹${journey.price}</p>
                </div>
                <div class="mt-4 space-y-2">
                    <button class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline book-journey-button" data-journey-id="${journey.id}">Book Journey</button>
                    <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline view-seats-button" data-journey-id="${journey.id}">View Seats</button>
                </div>
            </div>
        `;

        async function loadJourneys(filters = {}) {
             let url = `${API_BASE_URL}/journey/journeys/`;
            const queryParams = [];
            if (filters.source) queryParams.push(`source=${filters.source}`);
            if (filters.destination) queryParams.push(`destination=${filters.destination}`);
            if (filters.departure_date) queryParams.push(`departure_time=${filters.departure_date}`); // Changed to departure_time
            if (queryParams.length) url += `?${queryParams.join('&')}`;

            try {
                const journeys = await fetchData(url);
                const journeysList = document.getElementById('journeys-list');
                journeysList.innerHTML = journeys.map(journeyCardTemplate).join('');

                // Attach event listeners
                const bookButtons = journeysList.querySelectorAll('.book-journey-button');
                bookButtons.forEach(button => {
                    button.addEventListener('click', handleBookJourney);
                });
                const viewSeatsButtons = journeysList.querySelectorAll('.view-seats-button');
                viewSeatsButtons.forEach(button => {
                    button.addEventListener('click', handleViewSeats);
                });
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }



        // --- Booking Views ---
        const createBookingView = (journey) => `
            <div class="max-w-md mx-auto bg-white rounded-md shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Book Journey</h2>
                <div class="mb-4">
                    <p><span class="font-semibold">Journey:</span> ${journey.source} to ${journey.destination}</p>
                    <p><span class="font-semibold">Departure:</span> ${journey.departure_time}</p>
                    <p><span class="font-semibold">Price:</span> ₹${journey.price}</p>
                    <p><span class="font-semibold">Available Seats:</span> <span id="journey-available-seats">${journey.available_seats}</span></p>
                </div>
                <form id="create-booking-form" class="space-y-4">
                    <div>
                        <label for="seat_count" class="block text-gray-700 text-sm font-bold mb-2">Number of Seats:</label>
                        <input type="number" id="seat_count" name="seat_count" required min="1" max="${journey.available_seats}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div id="seat-selection-group" class="hidden">
                        <label for="seat_numbers" class="block text-gray-700 text-sm font-bold mb-2">Select Seats:</label>
                        <div id="seat-map" class="grid grid-cols-4 gap-2 mb-4">
                            </div>
                        <input type="text" id="seat_numbers" name="seat_numbers" class="hidden">
                    </div>
                    <div>
                        <label for="notes" class="block text-gray-700 text-sm font-bold mb-2">Notes (Optional):</label>
                        <textarea id="notes" name="notes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Confirm Booking</button>
                </form>
            </div>
        `;

        const myBookingsView = `
            <div class="space-y-6">
                <h2 class="text-2xl font-semibold text-gray-800">My Bookings</h2>
                <div id="my-bookings-list" class="space-y-4">
                    </div>
            </div>
        `;

        const bookingCardTemplate = (booking) => `
            <div class="bg-white rounded-md shadow-md p-4 flex flex-col justify-between">
                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Booking Reference: ${booking.booking_reference}</h3>
                    <p class="text-gray-600 mb-1">Journey: ${booking.journey.source} to ${booking.journey.destination}</p>
                    <p class="text-gray-600 mb-1">Departure: ${booking.journey.departure_time}</p>
                    <p class="text-gray-600 mb-1">Seats: ${booking.seat_count}</p>
                     <p class="text-gray-600 mb-1">Booked Seats: <span id="booked-seats-${booking.id}">${booking.seats.map(seat => seat.seat_number).join(', ')}</span></p>
                    <p class="text-gray-700 font-bold mb-2">Total Price: ₹${booking.total_price}</p>
                    <p class="text-gray-600 mb-2">Status: <span class="${booking.status === 'CANCELLED' ? 'text-red-500' : booking.status === 'CONFIRMED' ? 'text-green-500' : 'text-yellow-500'}">${booking.status}</span></p>
                    ${booking.notes ? `<p class="text-gray-600 mb-2">Notes: ${booking.notes}</p>` : ''}
                </div>
                <div class="mt-4 space-y-2">
                    <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline cancel-booking-button" data-booking-id="${booking.id}">Cancel Booking</button>
                     <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline view-payment-button" data-booking-id="${booking.id}">View Payment</button>
                    ${booking.status === 'CONFIRMED' ? `<button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline make-payment-button" data-booking-id="${booking.id}">Make Payment</button>` : ''}
                </div>
            </div>
        `;

        const paymentView = (booking) => `
            <div class="max-w-md mx-auto bg-white rounded-md shadow-md p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Payment for Booking: ${booking.booking_reference}</h2>
                <div id="payment-details" class="space-y-2 mb-4">
                    <p><span class="font-semibold">Booking ID:</span> <span id="payment-booking-id">${booking.id}</span></p>
                    <p><span class="font-semibold">Total Amount:</span> <span id="payment-amount">${booking.total_price}</span></p>
                    <p><span class="font-semibold">Status:</span> <span id="payment-status"></span></p>
                    <p><span class="font-semibold">Method:</span> <span id="payment-method"></span></p>
                    <p><span class="font-semibold">Transaction ID:</span> <span id="payment-transaction-id"></span></p>
                    <p><span class="font-semibold">Payment Time:</span> <span id="payment-time"></span></p>
                </div>
                <div id="make-payment-form" class="${booking.status === 'CONFIRMED' ? '' : 'hidden'} mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Make Payment</h3>
                    <form id="payment-form" class="space-y-4">
                        <div>
                            <label for="payment_method" class="block text-gray-700 text-sm font-bold mb-2">Payment Method:</label>
                            <input type="text" id="payment_method" name="payment_method" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        </div>
                        <div>
                            <label for="payment_details" class="block text-gray-700 text-sm font-bold mb-2">Payment Details (Optional):</label>
                            <textarea id="payment_details" name="payment_details" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                        </div>
                        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Complete Payment</button>
                    </form>
                </div>
                 <div id="refund-payment-section" class="${booking.status === 'COMPLETED' ? '' : 'hidden'} mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Refund Payment</h3>
                    <button id="refund-payment-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Refund Payment</button>
                </div>
            </div>
        `;

        const seatMapView = (journey, selectedSeats = []) => {
            const seatRows = ['A', 'B', 'C', 'D'];
            const seatsPerRow = 4;
            let seatMapHTML = '<div class="grid grid-cols-4 gap-2">';
            for (const row of seatRows) {
                for (let i = 1; i <= seatsPerRow; i++) {
                    const seatNumber = `${row}${i}`;
                    const isBooked = journey.seats.some(seat => seat.seat_number === seatNumber && seat.is_booked);
                    const isSelected = selectedSeats.includes(seatNumber);
                    let seatClass = 'seat-available';
                    if (isBooked) {
                        seatClass = 'seat-booked';
                    } else if (isSelected) {
                        seatClass = 'seat-selected';
                    }seatMapHTML += `<div class="${seatClass} rounded-md p-2 text-center cursor-pointer select-seat-button" data-seat-number="${seatNumber}">${seatNumber}</div>`;
                }
            }
            seatMapHTML += '</div>';
            return seatMapHTML;
        }

        async function handleBookJourney(event) {
            const journeyId = event.target.dataset.journeyId;
            try {
                const journey = await fetchData(`${API_BASE_URL}/journey/journeys/${journeyId}/`);
                sessionStorage.setItem('journey', JSON.stringify(journey)); //store journey
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = createBookingView(journey);

                const seatCountInput = document.getElementById('seat_count');
                const seatSelectionGroup = document.getElementById('seat-selection-group');
                const seatMapContainer = document.getElementById('seat-map');
                let selectedSeats = [];

                if(journey.available_seats > 0){
                    seatSelectionGroup.classList.remove('hidden');
                    const seats = await fetchData(`${API_BASE_URL}/journey/journeys/${journeyId}/seats/`);
                    journey.seats = seats;
                    seatMapContainer.innerHTML = seatMapView(journey, selectedSeats);

                     const selectSeatButtons = seatMapContainer.querySelectorAll('.select-seat-button');
                     selectSeatButtons.forEach(button => {
                        button.addEventListener('click', (event) => {
                            const seatNumber = event.target.dataset.seatNumber;
                            if (selectedSeats.includes(seatNumber)) {
                                selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                            } else if (selectedSeats.length < parseInt(seatCountInput.value)) {
                                selectedSeats.push(seatNumber);
                            } else {
                                showMessage(`You can only select ${seatCountInput.value} seats`, 'error');
                                return;
                            }
                            event.target.className = selectedSeats.includes(seatNumber) ? 'seat-selected rounded-md p-2 text-center cursor-pointer select-seat-button' :
                             journey.seats.find(s => s.seat_number === seatNumber).is_booked? 'seat-booked rounded-md p-2 text-center cursor-pointer select-seat-button' : 'seat-available rounded-md p-2 text-center cursor-pointer select-seat-button';
                            document.getElementById('seat_numbers').value = selectedSeats.join(',');
                        });
                    });
                }


                seatCountInput.addEventListener('change', () => {
                    const numSeats = parseInt(seatCountInput.value);
                    if (isNaN(numSeats) || numSeats <= 0) {
                        seatSelectionGroup.classList.add('hidden');
                        selectedSeats = [];
                        document.getElementById('seat_numbers').value = '';
                    }
                    else {
                        seatSelectionGroup.classList.remove('hidden');
                         if (selectedSeats.length > numSeats) {
                            selectedSeats = selectedSeats.slice(0, numSeats);
                            document.getElementById('seat_numbers').value = selectedSeats.join(',');
                            seatMapContainer.innerHTML = seatMapView(journey, selectedSeats);
                         }
                         else{
                            seatMapContainer.innerHTML = seatMapView(journey, selectedSeats);
                         }
                    }
                });

                document.getElementById('create-booking-form').addEventListener('submit', (event) => handleCreateBooking(event, journeyId));
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleCreateBooking(event, journeyId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
             const journey = JSON.parse(sessionStorage.getItem('journey'));
             data.journey = journeyId;
             data.seat_numbers = data.seat_numbers.split(',');

            try {
                const booking = await fetchData(`${API_BASE_URL}/journey/bookings/`, 'POST', data, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                showMessage('Booking created successfully!');
                showView('my-bookings');
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function loadMyBookings() {
            try {
                const bookings = await fetchData(`${API_BASE_URL}/journey/bookings/`, 'GET', null, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                const bookingsList = document.getElementById('my-bookings-list');
                bookingsList.innerHTML = bookings.map(bookingCardTemplate).join('');

                // Attach event listeners to the "Cancel Booking" buttons
                const cancelButtons = bookingsList.querySelectorAll('.cancel-booking-button');
                cancelButtons.forEach(button => {
                    button.addEventListener('click', handleCancelBooking);
                });

                const viewPaymentButtons = bookingsList.querySelectorAll('.view-payment-button');
                viewPaymentButtons.forEach(button => {
                    button.addEventListener('click', handleViewPayment);
                });
                const makePaymentButtons = bookingsList.querySelectorAll('.make-payment-button');
                makePaymentButtons.forEach(button => {
                    button.addEventListener('click', handleMakePayment);
                });
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleCancelBooking(event) {
            const bookingId = event.target.dataset.bookingId;
            try {
                await fetchData(`${API_BASE_URL}/journey/bookings/${bookingId}/`, 'DELETE', null, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                showMessage('Booking cancelled successfully!');
                loadMyBookings(); // Refresh the booking list
            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleViewPayment(event) {
            const bookingId = event.target.dataset.bookingId;
            try{
                const booking = await fetchData(`${API_BASE_URL}/journey/bookings/${bookingId}/`, 'GET', null, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                let paymentDetails = null;
                if(booking.payment){
                    paymentDetails = await fetchData(`${API_BASE_URL}/journey/payments/${booking.payment.id}/`, 'GET', null, {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    });
                }

                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = paymentView(booking);

                if(paymentDetails){
                    document.getElementById('payment-status').textContent = paymentDetails.status;
                    document.getElementById('payment-method').textContent = paymentDetails.payment_method;
                    document.getElementById('payment-transaction-id').textContent = paymentDetails.transaction_id;
                    document.getElementById('payment-time').textContent = paymentDetails.payment_time;
                }
                else{
                    document.getElementById('payment-details').innerHTML = "<p class='text-gray-500'>No payment found for this booking.</p>";
                    document.getElementById('make-payment-form').classList.remove('hidden');
                }

                if(booking.status === 'COMPLETED'){
                    document.getElementById('refund-payment-section').classList.remove('hidden');
                    const refundButton = document.getElementById('refund-payment-button');
                    refundButton.addEventListener('click', () => handleRefundPayment(booking.payment.id));
                }

            }
            catch(error){

            }
        }

        async function handleMakePayment(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const bookingId = event.target.dataset.bookingId;

            data.booking = bookingId;

            try {
                const payment = await fetchData(`${API_BASE_URL}/journey/payments/`, 'POST', data, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                showMessage('Payment successful!');
                loadMyBookings(); //refresh
                showView('my-bookings');

            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleRefundPayment(paymentId) {
             try {
                const refundedPayment = await fetchData(`${API_BASE_URL}/journey/payments/${paymentId}/refund/`, 'PATCH', null, {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                });
                showMessage('Payment refunded successfully!');
                loadMyBookings(); // Refresh the booking details
                showView('my-bookings');

            } catch (error) {
                 // Error is already handled in fetchData
            }
        }

        async function handleViewSeats(event){
            const journeyId = event.target.dataset.journeyId;
             try {
                const journey = await fetchData(`${API_BASE_URL}/journey/journeys/${journeyId}/`);
                const seats = await fetchData(`${API_BASE_URL}/journey/journeys/${journeyId}/seats/`);
                journey.seats = seats;

                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = seatMapView(journey);
            }
            catch(error){

            }
        }

        // --- Initial Setup ---
        const routes = {
            'home': `
                <div class="text-center">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Welcome to BookMyTicket</h2>
                    <p class="text-gray-600">Book your journey with ease!</p>
                </div>
            `,
            'login': loginView,
            'register': registerView,
            'profile': profileView,
            'journeys': journeysView,
            'my-bookings': myBookingsView,
        };

        let currentUser = null; // You would typically fetch this from localStorage or an API

        function showView(viewId) {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = routes[viewId] || '<div>Page not found</div>';

            // Attach event listeners for forms
            if (viewId === 'login') {
                document.getElementById('login-form').addEventListener('submit', handleLogin);
            } else if (viewId === 'register') {
                document.getElementById('register-form').addEventListener('submit', handleRegister);
            } else if (viewId === 'profile') {
                document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);
                document.getElementById('update-profile-form').addEventListener('submit', handleUpdateProfile);
                loadProfile();
            } else if (viewId === 'journeys') {
                loadJourneys();
                document.getElementById('search-journeys').addEventListener('click', () => {
                    const filters = {
                        source: document.getElementById('filter-source').value,
                        destination: document.getElementById('filter-destination').value,
                        departure_date: document.getElementById('filter-departure-date').value,
                    };
                    loadJourneys(filters);
                });
            } else if (viewId === 'my-bookings') {
                loadMyBookings();
            }
        }

        // --- Event Listeners for Navigation ---
        document.getElementById('home-link').addEventListener('click', () => showView('home'));
        document.getElementById('login-link').addEventListener('click', () => showView('login'));
        document.getElementById('register-link').addEventListener('click', () => showView('register'));
        document.getElementById('logout-link').addEventListener('click', handleLogout);
        document.getElementById('profile-link').addEventListener('click', () => showView('profile'));
        document.getElementById('journeys-link').addEventListener('click', () => showView('journeys'));
        document.getElementById('my-bookings-link').addEventListener('click', () => showView('my-bookings'));

        // --- Check for existing login on page load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check if the user is logged in (you'd normally check for a token in localStorage)
            // For this example, we'll just check if the logout button is visible
            if (localStorage.getItem('authToken')) {
                document.getElementById('login-link').classList.add('hidden');
                document.getElementById('register-link').classList.add('hidden');
                document.getElementById('logout-link').classList.remove('hidden');
                document.getElementById('profile-link').classList.remove('hidden');
                document.getElementById('journeys-link').classList.remove('hidden');
                document.getElementById('my-bookings-link').classList.remove('hidden');
                loadProfile();
                showView('home'); // Or redirect to a default logged-in view
            } else {
                showView('home'); // Show the home view by default
            }
        });
    </script>
</body>
</html>
